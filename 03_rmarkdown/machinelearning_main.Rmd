---
title: "Machine Learning I Group Work"
author: "Adriana Ricklin, Yvonne Schaerli, Christina Sudermann, Carole Mattmann"
date: "5 Maerz 2020"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r}
library(ggplot2)
library(gridExtra)

```

# Import and data cleaning

```{r}
insurance <- read.csv("../01_data/insurance.csv", header=TRUE)
str(insurance)


# smoker = 1 / nonsmoker = 0
insurance$smoker <- as.character(insurance$smoker)
insurance$smoker[insurance$smoker == "yes"] <- "1"
insurance$smoker[insurance$smoker == "no"] <- "0"
insurance$smoker <- as.factor(insurance$smoker)


head(insurance)

```

# Linear models -> Christina

```{r}

```

# Linear models (GAM & Polynomial) -> Yvonne 

```{r}

```

# GLM and cross validation -> Carole 

## Generalised Linear Models for count data

### Original data

The number of children an insured person has is analysed. We have the following data on children per person. The number of children ranges from 0 to 5 with a median of 1. 

```{r}
summary(insurance$children)
```

### Poisson model 

To model count data (number of children) the poisson model is used. An analysis performed beforehand showed that only the variables "charges" and "smoker" have a significant impact on the number of children. 

```{r}

glm.children <- glm(children ~ smoker+charges, 
                   data=insurance, 
                   family = "poisson")

summary(glm.children)

```

To get the coefficients, the log transformation needs to be reversed:

```{r}
exp(coef(glm.children)) 
```

Smoker (factor): The model shows that for the factor smoker (yes/no), a smoker has on average 72% of the number of children a non-smoker has. The more common-sense interpretation might be the other way around, that people who have 1 or more children smoke less, but for the moment we have no proof of that. 

Charges: A person with higher charges will on average have more children. If charges are increased by 1000 dollars, the calculated number of children increases by 1.4%. 

```{r eval=FALSE, include=FALSE}
coef(glm.children)["charges"]*1000
```

### Simulation of data and comparison

With the calculated model, data is simulated:

```{r echo=FALSE}
set.seed(5)
sim.data.glm.children <- simulate(glm.children)
summary(sim.data.glm.children)
```

The original and the simulated data are compared visually. The number of children from the simulated data (0-6) seem to be plausible. The distribution has a strong downwards trend starting at 1 like the original data. However the model does not seem to generate enough data with 0 children. 

```{r echo=FALSE}
df <- data.frame(insurance)
plot.original <- ggplot(df, 
                        aes(x=children))+ 
  geom_bar(fill="darkgreen")+
  labs(title = "Original data", x="number of children")

plot.sim <- ggplot(sim.data.glm.children, 
                   aes(x=sim_1))+
                     geom_bar(fill="darkblue")+
  labs(title = "Simulated data", x="number of children")

grid.arrange(plot.original, plot.sim, nrow=1)
```


## Generalised Linear Models for binomial data 


A model is fitted that predicts if a person is a smoker or not. Only the significant values age, bmi and charges are used. 

```{r}
glm.smoker.2 <- glm(smoker ~ age+bmi+charges, 
                    data=insurance, 
                    family = "binomial")

summary(glm.smoker.2)

exp(coef(glm.smoker.2)) 
```

Age and BMI has a negative effect on smoker. This means the higher a persons BMI and age, the lower the probability that the person is a smoker. 
Charges has a positive effect. This means the higher a persons charges, the higher is
the possibility that the person smokes.

### Graphical analysis

This can also be explored graphically, at least for charges it is clearly visible that smokers have higher charges. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

plot1 <- ggplot(data = insurance,
       mapping = aes(y = smoker,
                     x = age)) +
  geom_point(alpha = 0.05)

plot2 <- ggplot(data = insurance,
       mapping = aes(y = smoker,
                     x = bmi)) +
  geom_point(alpha = 0.05)

plot3 <- ggplot(data = insurance,
       mapping = aes(y = smoker,
                     x = charges)) +
  geom_point(alpha = 0.05)

grid.arrange(plot1, plot2, plot3, ncol=3)
```

### Estimating the model performance

The predicted values are transformed into binary (beforehand they inicated the probability) and compared with the actual data. 

```{r echo=TRUE, message=FALSE, warning=FALSE}

fitted.smoker.disc <- ifelse(fitted(glm.smoker.2) < 0.5,
                           yes = 0, no = 1)
head(fitted.smoker.disc)

d.obs.fit.smoker <- data.frame(obs = insurance$smoker,
                             fitted = fitted.smoker.disc)
head(d.obs.fit.smoker)
```

We observe the following fit:

```{r echo=FALSE, message=FALSE, warning=FALSE}

table(obs = d.obs.fit.smoker$obs,
      fit = d.obs.fit.smoker$fitted)
```

## Cross Validation -> Carole 

```{r}

```










